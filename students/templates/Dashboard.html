{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<title>Admin Dashboard | Student Learning</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
* {
  margin: 0; padding: 0;
  box-sizing: border-box;
  font-family: "Poppins", sans-serif;
}

body {
  background: linear-gradient(135deg, #e0f7fa, #ffffff);
  color: #0a3d3c;
  min-height: 100vh;
}

/* CONTAINER */
.container {
  max-width: 1350px;
  margin: 40px auto;
  background: #fff;
  padding: 25px;
  border-radius: 14px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.08);
}

/* TOP BAR */
.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.top-bar h3 {
  color: #00796b;
  font-size: 22px;
  font-weight: 600;
}

/* UNIVERSAL BUTTON THEME */
.add-topic-btn,
.excel-btn,
.filter-btn,
.reset-btn,
.edit-btn,
.delete-btn,
.modal-save,
.modal-cancel,
.modal-delete {
  background: linear-gradient(90deg, #009688, #00796b);
  color: #fff !important;
  font-weight: 600;
  border-radius: 8px;
  border: none;
  text-decoration: none;
  transition: 0.3s;
  padding: 8px 18px;
  font-size: 14px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.add-topic-btn:hover,
.excel-btn:hover,
.filter-btn:hover,
.reset-btn:hover,
.edit-btn:hover,
.delete-btn:hover,
.modal-save:hover,
.modal-cancel:hover,
.modal-delete:hover {
  background: linear-gradient(90deg, #00796b, #004d40);
  transform: translateY(-2px);
  color: #fff !important;
}

/* Small table buttons */
.edit-btn,
.delete-btn {
  padding: 6px 14px;
  font-size: 13px;
  border-radius: 6px;
}

/* FILTER BAR */
.filter-bar {
  margin-bottom: 15px;
  padding: 10px 14px;
  background: #f1fbfb;
  border-radius: 10px;
  border: 1px solid #cce7e4;
}

.filter-label {
  font-size: 13px;
  font-weight: 500;
  color: #00695c;
  margin-bottom: 4px;
}

/* TABLE */
table {
  width: 100%;
  border-collapse: collapse;
  border: 1px solid #cce7e4;
  font-size: 15px;
  margin-top: 10px;
}

th, td {
  border: 1px solid #e0f2f1;
  padding: 14px;
  vertical-align: middle;
}

th {
  background: #b2dfdb;
  color: #004d40;
}

tr:nth-child(even) { background: #f9fffd; }
tr:hover { background: #e0f7fa80; }

/* DESCRIPTION SCROLL BOX */
.desc-box {
  max-height: 90px;
  overflow-y: auto;
  white-space: pre-wrap;
}

/* ACTION BUTTONS WRAPPER */
.action-box {
  display: flex;
  gap: 10px;
  justify-content: center;
}

/* MODAL GLOBAL STYLING */
.modal-content {
  background: #f5fffd;
  border-radius: 14px;
  border: none;
}

/* EDIT MODAL HEADER */
.modal-header-edit {
  background: linear-gradient(90deg, #009688, #26a69a);
  color: #fff;
  border-top-left-radius: 14px;
  border-top-right-radius: 14px;
}

/* DELETE MODAL HEADER */
.modal-header-delete {
  background: linear-gradient(90deg, #e53935, #b71c1c);
  color: #fff;
  border-top-left-radius: 14px;
  border-top-right-radius: 14px;
}

/* MODAL FOOTER */
.modal-footer {
  background: #e0f7fa;
  border-bottom-left-radius: 14px;
  border-bottom-right-radius: 14px;
  border-top: none;
}

/* MODAL INPUT */
.modal-input {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #b2dfdb;
  margin-bottom: 14px;
}

.modal-label {
  font-weight: 500;
}

/* Centered Save button */
.modal-actions {
  display: flex;
  justify-content: center;
  margin-top: 10px;
}
</style>

</head>

<body>

{% include 'navbar.html' %}

<div class="container">

  <!-- TOP BAR -->
  <div class="top-bar">
    <h3>üìã All Topics</h3>

    <div>
      <a href="{% url 'add_topic' %}" class="add-topic-btn">‚ûï Add Topic</a>
      <a href="{% url 'export_excel' %}" class="excel-btn">‚¨áÔ∏è Download Excel</a>
    </div>
  </div>

  <!-- FILTERS -->
  <form method="get" class="filter-bar">

    <div class="row g-2">
      <div class="col-md-4">
        <label class="filter-label">Course</label>
        <select name="course" class="form-select">
          <option value="">All Courses</option>
          {% for c in courses %}
            <option value="{{ c.course_name }}"
              {% if selected_course == c.course_name %}selected{% endif %}>
              {{ c.course_name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="filter-label">Batch</label>
        <select name="batch" class="form-select">
          <option value="">All Batches</option>
          {% for b in batches %}
            <option value="{{ b.batch_name }}"
              {% if selected_batch == b.batch_name %}selected{% endif %}>
              {{ b.batch_name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="filter-label">Month</label>
        <select name="month" class="form-select">
          <option value="">All Months</option>
          <option value="1"  {% if selected_month == "1" %}selected{% endif %}>January</option>
          <option value="2"  {% if selected_month == "2" %}selected{% endif %}>February</option>
          <option value="3"  {% if selected_month == "3" %}selected{% endif %}>March</option>
          <option value="4"  {% if selected_month == "4" %}selected{% endif %}>April</option>
          <option value="5"  {% if selected_month == "5" %}selected{% endif %}>May</option>
          <option value="6"  {% if selected_month == "6" %}selected{% endif %}>June</option>
          <option value="7"  {% if selected_month == "7" %}selected{% endif %}>July</option>
          <option value="8"  {% if selected_month == "8" %}selected{% endif %}>August</option>
          <option value="9"  {% if selected_month == "9" %}selected{% endif %}>September</option>
          <option value="10" {% if selected_month == "10" %}selected{% endif %}>October</option>
          <option value="11" {% if selected_month == "11" %}selected{% endif %}>November</option>
          <option value="12" {% if selected_month == "12" %}selected{% endif %}>December</option>
        </select>
      </div>
    </div>

    <div class="row g-2 mt-2">
      <div class="col-md-3">
        <label class="filter-label">From Date</label>
        <input type="date" name="from_date" class="form-control" value="{{ from_date }}">
      </div>
      <div class="col-md-3">
        <label class="filter-label">To Date</label>
        <input type="date" name="to_date" class="form-control" value="{{ to_date }}">
      </div>
      <div class="col-md-3 d-grid">
        <label class="filter-label">&nbsp;</label>
        <button type="submit" class="filter-btn">Apply Filters</button>
      </div>
      <div class="col-md-3 d-grid">
        <label class="filter-label">&nbsp;</label>
        <a href="{% url 'admin_dashboard' %}" class="reset-btn text-center">Reset</a>
      </div>
    </div>

  </form>

  <!-- TABLE -->
 <table>
    <thead>
      <tr>
        <th>Full Name</th>
        <th>Course</th>
        <th>Batch</th>
        <th>Date</th>
        <th>Start</th>
        <th>End</th>
        <th>Total Hours</th>
        <th>Topic</th>
        <th>Description</th>
        <th>Trainer</th>
        <th>Status</th>
        <th>Zoom</th>
        <th class="text-center">Action</th>
      </tr>
    </thead>

    <tbody>
      {% for t in topics %}
      <tr>
        <td>{{ t.student.user.first_name }} {{ t.student.user.last_name }}</td>
        <td>{{ t.student.course.course_name }}</td>
        <td>{{ t.batch.batch_name }}</td>
        <td>{{ t.date }}</td>
        <td>{{ t.start_time }}</td>
        <td>{{ t.end_time }}</td>
        <td>{{ t.duration_display }}</td>
        <td>{{ t.title }}</td>
        <td><div class="desc-box">{{ t.description }}</div></td>
        <td>{{ t.trainer }}</td>

        <!-- UPDATED STATUS DISPLAY -->
        <td>
          {% if t.status == "completed" %}
              <span class="badge bg-success">Completed</span>

          {% elif t.status == "not_completed" %}
              <span class="badge bg-danger">Not Completed</span>

          {% elif t.status == "on_review" %}
              <span class="badge bg-info text-dark">On Review</span>

          {% else %}
              <span class="badge bg-warning text-dark">Pending</span>
          {% endif %}
        </td>

        <td>
          {% if t.zoom_link %}
            <a href="{{ t.zoom_link }}"
               target="_blank"
               style="background:#0288d1; padding:6px 12px; color:#fff; border-radius:6px; font-size:13px; text-decoration:none;">
               Join
            </a>
          {% else %}
            <span style="color:red; font-weight:600;">No Link</span>
          {% endif %}
        </td>

        <td class="text-center">
          <div class="action-box">

            <!-- EDIT BUTTON -->
            <button class="edit-btn"
                    type="button"
                    data-bs-toggle="modal"
                    data-bs-target="#editModal"
                    data-id="{{ t.id }}"
                    data-title="{{ t.title|escape }}"
                    data-description="{{ t.description|escape }}"
                    data-date="{{ t.date|date:'Y-m-d' }}"
                    data-start="{{ t.start_time|time:'H:i' }}"
                    data-end="{{ t.end_time|time:'H:i' }}"
                    data-trainer="{{ t.trainer|escape }}"
                    data-status="{{ t.status }}"
                    data-zoom="{{ t.zoom_link|default:'' }}">
              Edit
            </button>

            <button class="delete-btn"
                    type="button"
                    data-bs-toggle="modal"
                    data-bs-target="#deleteModal"
                    data-id="{{ t.id }}">
              Delete
            </button>

          </div>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="13" class="text-center py-3">No topics found.</td>
      </tr>
      {% endfor %}
    </tbody>
</table>

  {% if page_obj.has_other_pages %}
  <nav class="mt-3">
    <ul class="pagination justify-content-center">

      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if query_string %}&{{ query_string }}{% endif %}">Previous</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if num == page_obj.number %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% elif num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
          <li class="page-item">
            <a class="page-link" href="?page={{ num }}{% if query_string %}&{{ query_string }}{% endif %}">{{ num }}</a>
          </li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if query_string %}&{{ query_string }}{% endif %}">Next</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}

    </ul>
  </nav>
  {% endif %}

</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <form class="modal-content" id="topicEditForm" method="POST">
      {% csrf_token %}

      <div class="modal-header modal-header-edit">
        <h5 class="modal-title">‚úèÔ∏è Edit Topic</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- TITLE + TRAINER -->
        <div class="row">
          <div class="col-md-6">
            <label class="modal-label">Title</label>
            <input type="text" id="m_title" name="title" class="modal-input" required>
          </div>

          <div class="col-md-6">
            <label class="modal-label">Trainer</label>
            <input type="text" id="m_trainer" name="trainer" class="modal-input">
          </div>
        </div>

        <!-- DATE + STATUS -->
        <div class="row">
          <div class="col-md-6">
            <label class="modal-label">Date</label>
            <input type="date" id="m_date" name="date" class="modal-input" required>
          </div>

          <div class="col-md-6">
            <label class="modal-label">Status</label>
            <select id="m_status" name="status" class="modal-input">
              <option value="pending">Pending</option>
              <option value="completed">Completed</option>
              <option value="not_completed">Not Completed</option>
              <option value="on_review">On Review</option>
            </select>
          </div>
        </div>

        <!-- TIME -->
        <div class="row">
          <div class="col-md-6">
            <label class="modal-label">Start Time</label>
            <input type="time" id="m_start" name="start_time" class="modal-input" required>
          </div>

          <div class="col-md-6">
            <label class="modal-label">End Time</label>
            <input type="time" id="m_end" name="end_time" class="modal-input" required>
          </div>
        </div>

        <!-- ZOOM -->
        <div class="row">
          <div class="col-md-12">
            <label class="modal-label">Zoom Link</label>
            <input type="text" id="m_zoom" name="zoom_link" class="modal-input">
          </div>
        </div>

        <!-- DESCRIPTION -->
        <label class="modal-label">Description</label>
        <textarea id="m_description" name="description" class="modal-input" rows="6"></textarea>

        <div class="modal-actions">
          <button type="submit" class="modal-save">Save Changes</button>
        </div>

      </div>
    </form>
  </div>
</div>


<!-- DELETE MODAL -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content" id="deleteForm" method="POST">
      {% csrf_token %}

      <div class="modal-header modal-header-delete">
        <h5 class="modal-title">‚ö†Ô∏è Delete Topic</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-center">
        <p style="font-size:17px; font-weight:500;">Are you sure you want to delete this topic?</p>
      </div>

      <div class="modal-footer justify-content-center">
        <button type="button" class="modal-cancel" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="modal-delete">Delete</button>
      </div>

    </form>
  </div>
</div>


<!-- JS AUTOFILL FOR MODALS -->
<script>
document.addEventListener("click", function (e) {

    /* ---------------------------
       FILL EDIT MODAL DATA
    ---------------------------- */
    if (e.target.classList.contains("edit-btn")) {

        const btn = e.target;

        document.getElementById("topicEditForm").action =
            "/edit_topic/" + btn.dataset.id + "/";

        document.getElementById("m_title").value       = btn.dataset.title;
        document.getElementById("m_description").value = btn.dataset.description;
        document.getElementById("m_date").value        = btn.dataset.date;
        document.getElementById("m_start").value       = btn.dataset.start;
        document.getElementById("m_end").value         = btn.dataset.end;
        document.getElementById("m_trainer").value     = btn.dataset.trainer;

        document.getElementById("m_status").value      = btn.dataset.status;
        document.getElementById("m_zoom").value        = btn.dataset.zoom || "";
    }

    /* ---------------------------
       DELETE MODAL SET ID
    ---------------------------- */
    if (e.target.classList.contains("delete-btn")) {
        document.getElementById("deleteForm").action =
            "/delete_topic/" + e.target.dataset.id + "/";
    }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


</body>
</html>
