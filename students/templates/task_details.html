{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Task Details | Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins",sans-serif;}
body{background:linear-gradient(135deg,#d1f2eb,#ffffff);min-height:100vh;color:#004d40;}
.container-box{width:95%;max-width:1400px;margin:40px auto;background:white;padding:25px;border-radius:16px;border:2px solid #b2dfdb;box-shadow:0 5px 20px rgba(0,0,0,0.1);}
.header-section h2{color:#00796b;font-size:28px;font-weight:700;margin-bottom:20px;}
.table-wrapper{width:100%;overflow:hidden;}
table{width:100%;table-layout:fixed;border-collapse:collapse;}
th{background:linear-gradient(90deg,#009688,#26a69a);padding:8px;color:white;text-align:center;font-size:13px;}
td{padding:8px;border-bottom:1px solid #e0f2f1;text-align:center;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.status-pill{padding:4px 10px;border-radius:50px;color:white;font-size:11px;font-weight:600;}
.status-pending{background:#ef6c00;}
.status-completed{background:#2e7d32;}
.status-progress{background:#0288d1;}
.status-review{background:#6a1b9a;}
.action-btn{padding:5px 10px;font-size:11px;border:none;border-radius:6px;color:white;}
.btn-edit{background:#0288d1;}
.btn-delete{background:#c62828;}
</style>
</head>

<body>

{% include "navbar.html" %}

<div class="container-box">

<div class="header-section">
  <h2>ðŸ“‹ Task Details</h2>
</div>

<div class="table-wrapper">
<table>
<thead>
<tr>
  <th>#</th>
  <th>Date</th>
  <th>Name</th>
  <th>Course</th>
  <th>Batch</th>
  <th>Est.</th>
  <th>Deadline</th>
  <th>Notes</th>
  <th>Status</th>
  <th>Task PDF</th>
  <th>Actions</th>
</tr>
</thead>

<tbody>
{% for t in tasks %}
<tr>
  <td>{{ forloop.counter }}</td>
  <td>{{ t.date|date:"d-m-Y" }}</td>
  <td>{{ t.student.user.first_name }}</td>
  <td>{{ t.student.course.course_name }}</td>
  <td>{{ t.student.batch.batch_name }}</td>
  <td>{{ t.estimated_time|default:"-" }}</td>
  <td>{% if t.deadline %}{{ t.deadline|date:"d-m-Y" }}{% else %}-{% endif %}</td>
  <td title="{{ t.task_notes }}">{{ t.task_notes|default:"-"|truncatechars:15 }}</td>

  <td>
    {% if t.status == "pending" %}
      <span class="status-pill status-pending">Pending</span>
    {% elif t.status == "completed" %}
      <span class="status-pill status-completed">Completed</span>
    {% elif t.status == "not_completed" %}
      <span class="status-pill status-progress">Not Done</span>
    {% else %}
      <span class="status-pill status-review">Review</span>
    {% endif %}
  </td>

  <td>
    {% if t.submissions.exists %}
      <a href="{{ t.submissions.first.file.url }}" class="btn btn-success btn-sm" target="_blank">View</a>
    {% else %}
      <span class="text-danger">No File</span>
    {% endif %}
  </td>

  <td>
    <button class="action-btn btn-edit"
      data-bs-toggle="modal"
      data-bs-target="#editModal"
      onclick="editTask(
        '{{ t.id }}',
        '{{ t.estimated_time }}',
        '{{ t.deadline|date:"Y-m-d" }}',
        `{{ t.task_notes|escapejs }}`,
        '{{ t.status }}'
      )">Edit</button>

    <button class="action-btn btn-delete"
      data-bs-toggle="modal"
      data-bs-target="#deleteModal"
      onclick="deleteTask('{{ t.id }}')">Delete</button>
  </td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
</div>

<!-- ================= EDIT MODAL ================= -->
<div class="modal fade" id="editModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h4 class="text-center text-primary mb-3">Edit Task</h4>

      <form method="POST" id="editForm">
        {% csrf_token %}

        <label>Estimated Time</label>
        <input type="number" step="0.1" name="estimated_time" id="task_estimated" class="form-control mb-2">

        <label>Deadline</label>
        <input type="date" name="deadline" id="task_deadline" class="form-control mb-2">

        <label>Task Notes</label>
        <textarea name="task_notes" id="task_notes" class="form-control mb-2"></textarea>

        <label>Status</label>
        <select class="form-control" name="status" id="task_status">
          <option value="pending">Pending</option>
          <option value="completed">Completed</option>
          <option value="not_completed">Not Completed</option>
          <option value="review">Review</option>
        </select>

        <button class="btn btn-success w-100 mt-3">Update Task</button>
      </form>
    </div>
  </div>
</div>

<!-- ================= DELETE MODAL ================= -->
<div class="modal fade" id="deleteModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h4 class="text-center text-danger mb-3">Delete Task?</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-secondary w-50" data-bs-dismiss="modal">Cancel</button>
        <a id="deleteBtn" class="btn btn-danger w-50">Delete</a>
      </div>
    </div>
  </div>
</div>

<script>
function editTask(id, est, deadline, notes, status){
  document.getElementById("task_estimated").value = est || "";
  document.getElementById("task_deadline").value = deadline || "";
  document.getElementById("task_notes").value = notes || "";
  document.getElementById("task_status").value = status;

  // âœ… FIXED URL
  document.getElementById("editForm").action = "/edit_task/" + id + "/";
}

function deleteTask(id){
  document.getElementById("deleteBtn").href = "/delete_topic/" + id + "/";
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
