{% load static %}
{% load tz %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin | Payments</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
  background:#f4fefe;
  font-family:"Poppins",sans-serif;
}
.container{
  max-width:1200px;
  margin-top:40px;
}
.card{
  border-radius:16px;
  border:none;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
}
.card-header{
  background:linear-gradient(90deg,#009688,#26a69a);
  color:#fff;
  font-size:20px;
  font-weight:600;
}

/* ================= TABLE (NO SCROLL, PERFECT ALIGNMENT) ================= */
.table{
  width:100%;
  border-collapse:collapse;
  margin-bottom:0;
}
.table th,
.table td{
  text-align:center;
  vertical-align:middle;
  font-size:14px;
  padding:10px;
  white-space:nowrap;
}
.table thead th{
  background:#009688;
  color:#fff;
  font-weight:600;
  border:1px solid #009688;
}
.table tbody td{
  border:1px solid #dee2e6;
}

/* IMPORTANT: no internal scroll */
.table-responsive{
  overflow-x:auto;
  overflow-y:visible;
}

/* ================= BADGES ================= */
.badge-pending{ background:#ff9800; }
.badge-approved{ background:#4caf50; }
.badge-rejected{ background:#f44336; }

/* ================= BUTTONS ================= */
.btn{
  border-radius:6px;
  padding:4px 10px;
}
.btn-approve{ background:#4caf50; color:#fff; }
.btn-edit{ background:#673ab7; color:#fff; }
.btn-view{ background:#0277bd; color:#fff; }

/* ================= MODALS ================= */
.modal-img{
  width:100%;
  border-radius:10px;
}
.modal-header.bg-success{
  border-top-left-radius:16px;
  border-top-right-radius:16px;
}

@media(max-width:768px){
  .table{
    font-size:12px;
  }
}
</style>
</head>

<body>

{% include "navbar.html" %}

<div class="container">
  <div class="card">
    <div class="card-header">üí≥ Student Payments</div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>#</th>
              <th>Student</th>
              <th>Email</th>
              <th>Amount</th>
              <th>Course Amount</th>
              <th>Paid Amount</th>
              <th>Balance Amount</th>
              <th>UTR</th>
              <th>Payment Date</th>
              <th>Screenshot</th>
              <th>Status</th>
              <th>Admin Remark</th>
              <th>Action</th>
            </tr>
          </thead>

          <tbody>
          {% for p in payments %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ p.student.user.first_name }}</td>
              <td>{{ p.student.user.email }}</td>
              <td>‚Çπ{{ p.amount_paid }}</td>
              <td>‚Çπ{{ p.course_amount }}</td>
              <td class="text-success">‚Çπ{{ p.approved_paid }}</td>
              <td class="text-danger">‚Çπ{{ p.balance_amount }}</td>
              <td>{{ p.utr|default:"‚Äî" }}</td>
              <td>
                {{ p.created_at|localtime|date:"d M Y" }}
                <span class="text-muted ms-1">
                  {{ p.created_at|localtime|time:"h:i A" }}
                </span>
              </td>

              <!-- Screenshot -->
              <td>
                {% if p.screenshot %}
                <button class="btn btn-view btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#imgModal{{ p.id }}">
                  View
                </button>

                <div class="modal fade" id="imgModal{{ p.id }}" tabindex="-1">
                  <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Payment Screenshot</h5>
                        <button class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body text-center">
                        <img src="{{ p.screenshot.url }}" class="modal-img">
                      </div>
                    </div>
                  </div>
                </div>
                {% else %}
                ‚Äî
                {% endif %}
              </td>

              <!-- Status -->
              <td>
                {% if p.status == "approved" %}
                  <span class="badge badge-approved">Approved</span>
                {% elif p.status == "pending" %}
                  <span class="badge badge-pending">Pending</span>
                {% else %}
                  <span class="badge badge-rejected">Rejected</span>
                {% endif %}
              </td>

              <td>{{ p.admin_remark|default:"‚Äî" }}</td>

              <!-- ACTIONS -->
              <td class="d-flex justify-content-center gap-1">

                {% if p.status == "pending" %}
                <button class="btn btn-approve btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#approveModal{{ p.id }}">
                  ‚úì
                </button>
                {% endif %}

                <button class="btn btn-edit btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#editModal{{ p.id }}">
                  ‚úèÔ∏è
                </button>

                <!-- APPROVE MODAL -->
                <div class="modal fade" id="approveModal{{ p.id }}" tabindex="-1">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">Confirm Approval</h5>
                        <button class="btn-close btn-close-white"
                                data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body text-center">
                        <p class="fs-5 mb-2">Approve this payment?</p>
                        <p class="text-muted mb-0">
                          Student: <b>{{ p.student.user.first_name }}</b><br>
                          Amount: <b>‚Çπ{{ p.amount_paid }}</b>
                        </p>
                      </div>
                      <div class="modal-footer justify-content-center">
                        <button class="btn btn-secondary" data-bs-dismiss="modal">
                          Cancel
                        </button>
                        <a href="{% url 'approve_payment' p.id %}"
                           class="btn btn-success px-4">
                          Approve
                        </a>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- EDIT MODAL -->
                <div class="modal fade" id="editModal{{ p.id }}" tabindex="-1">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <form method="post" action="{% url 'edit_payment' p.id %}">
                        {% csrf_token %}
                        <div class="modal-header">
                          <h5 class="modal-title">Edit Payment</h5>
                          <button class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <div class="modal-body text-start">
                          <label class="fw-bold mb-1">Status</label>
                          <select name="status" class="form-select mb-3" required>
                            <option value="approved" {% if p.status == "approved" %}selected{% endif %}>Approved</option>
                            <option value="rejected" {% if p.status == "rejected" %}selected{% endif %}>Rejected</option>
                            <option value="pending" {% if p.status == "pending" %}selected{% endif %}>Pending</option>
                          </select>

                          <label class="fw-bold mb-1">Admin Remark</label>
                          <textarea name="admin_remark"
                                    class="form-control"
                                    rows="3">{{ p.admin_remark }}</textarea>
                        </div>

                        <div class="modal-footer">
                          <button class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancel
                          </button>
                          <button type="submit" class="btn btn-success">
                            Save Changes
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>

              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="13" class="text-center text-danger fw-bold">
                No payments found
              </td>
            </tr>
          {% endfor %}
          </tbody>

        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
